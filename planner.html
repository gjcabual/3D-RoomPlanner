<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>3D Room Planner</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="control.js"></script>
    <style>
      body {
        margin: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #1a1a1a;
        overflow: hidden;
      }

      /* Side Panel Styles */
      #side-panel {
        position: fixed;
        left: -280px;
        top: 0;
        width: 280px;
        height: 100vh;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
        z-index: 1500;
        transition: left 0.3s ease;
        overflow-y: auto;
      }

      #side-panel.open {
        left: 0;
      }

      .panel-header {
        padding: 20px;
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        text-align: center;
      }

      .panel-header h3 {
        margin: 0;
        font-size: 1.2em;
        font-weight: 500;
      }

      .model-category {
        margin: 20px 0;
      }

      .category-title {
        padding: 10px 20px;
        background: #f8f9fa;
        color: #333;
        font-weight: 600;
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 1px;
        border-left: 4px solid #667eea;
      }

      .model-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        padding: 15px;
      }

      .model-item {
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        padding: 15px;
        text-align: center;
        transition: all 0.3s ease;
        user-select: none;
        position: relative;
      }

      .model-item.enabled {
        cursor: grab;
      }

      .model-item.enabled:hover {
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .model-item.enabled:active {
        cursor: grabbing;
        transform: scale(0.95);
      }

      .model-item.disabled {
        opacity: 0.4;
        cursor: not-allowed;
        background: #f5f5f5;
      }

      .model-item.dragging {
        opacity: 0.5;
        transform: rotate(5deg);
      }

      .disabled-overlay {
        position: absolute;
        top: 5px;
        right: 5px;
        background: #ff6b6b;
        color: white;
        font-size: 0.7em;
        padding: 2px 6px;
        border-radius: 3px;
        font-weight: bold;
      }

      .model-icon {
        font-size: 2em;
        margin-bottom: 8px;
        display: block;
      }

      .model-name {
        font-size: 0.8em;
        color: #666;
        font-weight: 500;
      }

      /* Panel Toggle Button - Better positioned */
      #panel-toggle {
        position: fixed;
        left: 20px;
        bottom: 30px;
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 15px;
        border-radius: 50%;
        cursor: pointer;
        z-index: 1600;
        font-size: 1.4em;
        transition: all 0.3s ease;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }

      #panel-toggle:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
      }

      /* Instructions - Better positioned for centered workspace */
      #instructions {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 20px;
        font-family: Arial, sans-serif;
        border-radius: 12px;
        z-index: 1000;
        max-width: 320px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
        transform: translateX(0);
      }

      #instructions.collapsed {
        transform: translateX(calc(100% - 50px));
        max-width: 50px;
        padding: 15px 10px;
      }

      #instructions.collapsed .instructions-content {
        display: none;
      }

      #instructions-toggle {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.3s ease;
      }

      #instructions-toggle:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      #instructions.collapsed #instructions-toggle {
        position: static;
        width: 100%;
        margin: 0;
        padding: 10px;
        font-size: 1.2em;
      }

      /* Cost Estimator Panel (Right side) */
      #cost-panel {
        position: fixed;
        right: 0;
        top: 0;
        width: 280px;
        height: 100vh;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        box-shadow: -2px 0 20px rgba(0, 0, 0, 0.1);
        z-index: 1500;
        display: flex;
        flex-direction: column;
      }

      .cost-header {
        padding: 20px;
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        text-align: center;
      }

      .cost-header h3 {
        margin: 0;
        font-size: 1.1em;
        font-weight: 500;
      }

      .cost-body {
        padding: 15px;
        overflow-y: auto;
        flex: 1;
      }

      .cost-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
        font-size: 0.95em;
      }

      .cost-item-name {
        color: #333;
        font-weight: 600;
      }

      .cost-item-meta {
        color: #666;
        font-size: 0.85em;
      }

      .cost-footer {
        padding: 15px 20px;
        border-top: 1px solid #eaeaea;
        background: rgba(255, 255, 255, 0.9);
      }

      .cost-total-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 700;
        color: #333;
        font-size: 1.05em;
      }

      @media (max-width: 1024px) {
        #cost-panel {
          width: 240px;
        }
      }

      /* Back Button - Better styling for centered workspace */
      #back-button {
        position: fixed;
        top: 20px;
        left: 20px;
        background: rgba(255, 255, 255, 0.95);
        color: #333;
        border: none;
        padding: 12px 18px;
        border-radius: 10px;
        cursor: pointer;
        z-index: 1700;
        font-size: 0.95em;
        font-weight: 500;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(0, 0, 0, 0.1);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      #back-button:hover {
        background: rgba(255, 255, 255, 1);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      /* Drop Zone Indicator */
      .drop-indicator {
        position: fixed;
        pointer-events: none;
        background: rgba(102, 126, 234, 0.3);
        border: 2px dashed #667eea;
        border-radius: 10px;
        display: none;
        z-index: 999;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 200px;
        height: 100px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #667eea;
        font-weight: bold;
        font-size: 1.1em;
      }

      .drop-indicator.show {
        display: flex;
      }

      /* Furniture Control Panel */
      #furniture-control-panel {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        z-index: 2000;
        display: none;
        min-width: 300px;
        text-align: center;
      }

      #furniture-control-panel h3 {
        margin: 0 0 15px 0;
        color: #333;
        font-size: 1.2em;
      }

      .control-buttons {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-bottom: 15px;
      }

      .control-btn {
        padding: 12px 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 500;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .control-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .control-btn.rotate-left {
        background: linear-gradient(45deg, #ff5722, #f44336);
        color: white;
      }

      .control-btn.rotate-right {
        background: linear-gradient(45deg, #4caf50, #388e3c);
        color: white;
      }

      .control-btn.delete {
        background: linear-gradient(45deg, #f44336, #d32f2f);
        color: white;
      }

      .control-btn.color {
        background: linear-gradient(45deg, #9e9e9e, #757575);
        color: white;
        cursor: not-allowed;
        opacity: 0.6;
      }

      .close-controls {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.1);
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2em;
        color: #666;
      }

      .close-controls:hover {
        background: rgba(0, 0, 0, 0.2);
      }

      /* Responsive */
      @media (max-width: 768px) {
        #cost-panel {
          display: none;
        }
        #side-panel {
          width: 100vw;
          left: -100vw;
        }

        .model-grid {
          grid-template-columns: repeat(3, 1fr);
        }

        #instructions {
          right: 10px;
          left: 10px;
          max-width: none;
          top: 60px;
        }

        #furniture-control-panel {
          min-width: 280px;
          padding: 15px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Back Button -->
    <button id="back-button" onclick="goBack()">‚Üê Back to Setup</button>

    <!-- Side Panel Toggle Button -->
    <button id="panel-toggle" onclick="togglePanel()">üì¶</button>

    <!-- Cost Estimator Panel (hidden; replaced by in-scene board) -->
    <div id="cost-panel" style="display: none"></div>

    <!-- Side Panel with 3D Models -->
    <div id="side-panel">
      <div class="panel-header">
        <h3>üéØ Furniture Library</h3>
        <small>Drag & drop furniture into your room</small>
      </div>

      <div class="model-category">
        <div class="category-title">üçΩÔ∏è Tables</div>
        <div class="model-grid">
          <div
            class="model-item enabled"
            draggable="true"
            data-model="table1"
            data-scale="1 1 1"
          >
            <span class="model-icon">
              <!-- Inline SVG: simple table icon -->
              <svg
                width="28"
                height="22"
                viewBox="0 0 28 22"
                xmlns="http://www.w3.org/2000/svg"
              >
                <rect x="2" y="2" width="24" height="4" rx="1" fill="#6b7280" />
                <rect x="3" y="6" width="2" height="14" rx="1" fill="#6b7280" />
                <rect
                  x="23"
                  y="6"
                  width="2"
                  height="14"
                  rx="1"
                  fill="#6b7280"
                />
                <rect x="8" y="6" width="2" height="10" rx="1" fill="#6b7280" />
                <rect
                  x="18"
                  y="6"
                  width="2"
                  height="10"
                  rx="1"
                  fill="#6b7280"
                />
              </svg>
            </span>
            <div class="model-name">Center Table</div>
          </div>
          <div class="model-item disabled" data-model="coffee-table">
            <div class="disabled-overlay">SOON</div>
            <span class="model-icon">‚òï</span>
            <div class="model-name">Coffee Table</div>
          </div>
          <div class="model-item disabled" data-model="desk">
            <div class="disabled-overlay">SOON</div>
            <span class="model-icon">üíª</span>
            <div class="model-name">Desk</div>
          </div>
          <div class="model-item disabled" data-model="side-table">
            <div class="disabled-overlay">SOON</div>
            <span class="model-icon">ü™ë</span>
            <div class="model-name">Side Table</div>
          </div>
        </div>
      </div>

      <div class="model-category">
        <div class="category-title">ü™ë Seating</div>
        <div class="model-grid">
          <div class="model-item disabled" data-model="chair">
            <div class="disabled-overlay">SOON</div>
            <span class="model-icon">ü™ë</span>
            <div class="model-name">Chair</div>
          </div>
          <div class="model-item disabled" data-model="sofa">
            <div class="disabled-overlay">SOON</div>
            <span class="model-icon">üõãÔ∏è</span>
            <div class="model-name">Sofa</div>
          </div>
          <div class="model-item disabled" data-model="armchair">
            <div class="disabled-overlay">SOON</div>
            <span class="model-icon">üõãÔ∏è</span>
            <div class="model-name">Armchair</div>
          </div>
          <div class="model-item disabled" data-model="stool">
            <div class="disabled-overlay">SOON</div>
            <span class="model-icon">ü™ë</span>
            <div class="model-name">Stool</div>
          </div>
        </div>
      </div>

      <div class="model-category">
        <div class="category-title">üõèÔ∏è Bedroom</div>
        <div class="model-grid">
          <div class="model-item disabled" data-model="bed">
            <div class="disabled-overlay">SOON</div>
            <span class="model-icon">üõèÔ∏è</span>
            <div class="model-name">Bed</div>
          </div>
          <div
            class="model-item enabled"
            draggable="false"
            data-category="wardrobe"
            onclick="showWardrobeSubcategory()"
          >
            <span class="model-icon">üëî</span>
            <div class="model-name">Wardrobe</div>
          </div>
          <div class="model-item disabled" data-model="dresser">
            <div class="disabled-overlay">SOON</div>
            <span class="model-icon">ü™û</span>
            <div class="model-name">Dresser</div>
          </div>
          <div class="model-item disabled" data-model="nightstand">
            <div class="disabled-overlay">SOON</div>
            <span class="model-icon">üí°</span>
            <div class="model-name">Nightstand</div>
          </div>
        </div>
      </div>

      <!-- Wardrobe Subcategory (hidden by default) -->
      <div
        class="model-category"
        id="wardrobe-subcategory"
        style="display: none"
      >
        <div class="category-title">üëî Wardrobe Options</div>
        <div class="model-grid">
          <div
            class="model-item enabled"
            draggable="true"
            data-model="wardrobe1"
            data-scale="1 1 1"
          >
            <span class="model-icon">üëî</span>
            <div class="model-name">Wardrobe 1</div>
          </div>
          <div
            class="model-item enabled"
            draggable="true"
            data-model="wardrobe2"
            data-scale="1 1 1"
          >
            <span class="model-icon">üëî</span>
            <div class="model-name">Wardrobe 2</div>
          </div>
          <div
            class="model-item enabled"
            draggable="true"
            data-model="wardrobe3"
            data-scale="1 1 1"
          >
            <span class="model-icon">üëî</span>
            <div class="model-name">Wardrobe 3</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Instructions -->
    <div id="instructions">
      <button id="instructions-toggle" onclick="toggleInstructions()">?</button>
      <div class="instructions-content">
        <p><strong>üéÆ Controls:</strong></p>
        <p>W/A/S/D ‚Üí Move around</p>
        <p>Q/R ‚Üí Move Up | E/F ‚Üí Move Down</p>
        <p>SPACE ‚Üí Up | SHIFT ‚Üí Down</p>
        <p>Mouse ‚Üí Look around</p>
        <hr style="margin: 10px 0; border-color: #666" />
        <p><strong>üçΩÔ∏è Furniture:</strong></p>
        <p>üì¶ Click panel button to open library</p>
        <p>üñ±Ô∏è Drag the center table into your room</p>
        <p>üéØ Table will snap to floor automatically</p>
        <p>üñ±Ô∏è Click table to select (turns green)</p>
        <p>üîÑ Use arrow buttons to rotate selected furniture</p>
        <hr style="margin: 10px 0; border-color: #666" />
        <p><strong>üìä Cost Board:</strong></p>
        <p>üìã Simple white panel - positioned at right wall</p>
        <p>üí∞ Shows furniture costs and total</p>
        <p>üëÄ Walk around to view from different angles</p>
        <p
          id="room-info"
          style="
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #666;
          "
        ></p>
      </div>
    </div>

    <!-- Drop Indicator -->
    <div class="drop-indicator" id="drop-indicator">üìç Drop Table Here</div>

    <!-- Furniture Control Panel -->
    <div id="furniture-control-panel">
      <button class="close-controls" onclick="closeControlPanel()">√ó</button>
      <h3 id="control-panel-title">Furniture Controls</h3>
      <div class="control-buttons">
        <button class="control-btn rotate-left" onclick="rotateFurnitureLeft()">
          ‚Ü∂ Rotate Left
        </button>
        <button
          class="control-btn rotate-right"
          onclick="rotateFurnitureRight()"
        >
          ‚Ü∑ Rotate Right
        </button>
        <button class="control-btn delete" onclick="deleteFurniture()">
          üóëÔ∏è Delete
        </button>
        <button class="control-btn color" disabled>üé® Color (Soon)</button>
      </div>
    </div>

    <!-- A-Frame Scene - Full Screen Workspace -->
    <a-scene
      id="scene"
      embedded
      style="height: 100vh; width: 100vw"
      vr-mode-ui="enabled: false"
    >
      <!-- Sky/Background -->
      <a-sky color="#87CEEB"></a-sky>

      <!-- Camera Rig with continuous movement -->
      <a-entity id="cameraRig" position="0 1.6 5" custom-movement>
        <a-camera
          look-controls="pointerLockEnabled: false; enabled: true; magicWindowTrackingEnabled: false"
          wasd-controls="enabled: false"
          cursor="rayOrigin: mouse"
        ></a-camera>
      </a-entity>

      <!-- Enhanced Lighting -->
      <a-light type="ambient" color="#ffffff" intensity="0.6"></a-light>
      <a-light
        type="directional"
        position="10 15 5"
        color="#ffffff"
        intensity="0.8"
        shadow="cast: true"
      ></a-light>
      <a-light
        type="point"
        position="0 5 0"
        color="#ffffff"
        intensity="0.3"
      ></a-light>

      <!-- Floor with non-reflective material -->
      <a-plane
        id="floor"
        rotation="-90 0 0"
        width="10"
        height="10"
        color="#7BC8A4"
        material="roughness: 1; metalness: 0"
        shadow="receive: true"
        floor-resize
      ></a-plane>

      <!-- Room Walls -->
      <a-entity id="room-walls"></a-entity>

      <!-- Furniture Container -->
      <a-entity id="furniture-container"></a-entity>

      <!-- Grid helper for better spatial awareness -->
      <a-entity id="grid-helper" visible="false"></a-entity>

      <!-- In-Scene Cost Board -->
      <a-entity id="cost-board" position="-3 2 -3" rotation="0 45 0">
        <a-plane
          width="2.2"
          height="1.2"
          color="#ffffff"
          material="roughness: 1; metalness: 0"
          opacity="1.0"
          shadow="receive: true"
        ></a-plane>
        <a-text
          value="Cost Estimator"
          color="#333"
          position="-1 0.45 0.01"
          width="3"
        ></a-text>
        <a-entity id="cost-lines" position="-1 0.25 0.01"></a-entity>
        <a-text
          id="cost-total-text"
          value="Total: ‚Ç±0.00"
          color="#333"
          position="-1 -0.45 0.01"
          width="3"
        ></a-text>
      </a-entity>
    </a-scene>

    <script>
      let draggedItem = null;
      let furnitureCounter = 0;
      let panelOpen = false;
      let selectedFurniture = null; // Track currently selected furniture
      const PRICE_LIST = {
        table1: 8500, // ‚Ç±8,500 dummy price for center table
        wardrobe1: 12000, // ‚Ç±12,000 dummy price for wardrobe 1
        wardrobe2: 15000, // ‚Ç±15,000 dummy price for wardrobe 2
        wardrobe3: 18000, // ‚Ç±18,000 dummy price for wardrobe 3
      };
      const costState = {
        items: {}, // key -> {name, price, qty}
        total: 0,
      };

      // Initialize the room with dimensions from localStorage
      function initializeRoom() {
        const width = localStorage.getItem("roomWidth");
        const length = localStorage.getItem("roomLength");

        if (!width || !length) {
          alert("No room dimensions found. Redirecting to setup...");
          window.location.href = "index.html";
          return;
        }

        console.log(
          "Initializing room with dimensions:",
          width + "M x " + length + "M"
        );

        // Convert m to A-Frame units (1:1 ratio)
        const aframeWidth = parseFloat(width);
        const aframeLength = parseFloat(length);

        // Update floor size
        const floor = document.getElementById("floor");
        floor.setAttribute("width", aframeWidth);
        floor.setAttribute("height", aframeLength);

        // Create room walls
        createRoomWalls(aframeWidth, aframeLength);

        // Position in-scene cost board at the right wall
        const costBoard = document.getElementById("cost-board");
        if (costBoard) {
          const boardX = aframeWidth / 2 - 0.1; // position just inside the wall for visibility
          costBoard.setAttribute("position", `${boardX} 1.5 0`);
          costBoard.setAttribute("rotation", `0 -90 0`);
          console.log(`Cost board positioned at: ${boardX} 1.5 0`);
        }

        // Update room info
        document.getElementById(
          "room-info"
        ).innerHTML = `<strong>Room:</strong> ${width}M √ó ${length}M`;

        // Position camera appropriately
        const cameraRig = document.getElementById("cameraRig");
        const cameraDistance = Math.max(aframeWidth, aframeLength) * 0.8;
        cameraRig.setAttribute("position", `0 1.6 ${cameraDistance}`);

        // Wait for scene to be ready, then initialize drag and drop
        const scene = document.querySelector("a-scene");
        if (scene.hasLoaded) {
          initializeDragAndDrop();
        } else {
          scene.addEventListener("loaded", initializeDragAndDrop);
        }

        // Test movement system
        setTimeout(() => {
          console.log(
            "Movement system should be ready. Try WASD keys and Q/E for up/down."
          );
          console.log(
            "If movement doesn't work, check the browser console for error messages."
          );
        }, 1000);
      }

      function createRoomWalls(width, length) {
        const wallsContainer = document.getElementById("room-walls");
        const wallHeight = 3;
        const wallThickness = 0.1;

        wallsContainer.innerHTML = "";

        // Create walls with better materials
        const walls = [
          {
            pos: `0 ${wallHeight / 2} ${-length / 2}`,
            size: `${width} ${wallHeight} ${wallThickness}`,
          },
          {
            pos: `0 ${wallHeight / 2} ${length / 2}`,
            size: `${width} ${wallHeight} ${wallThickness}`,
          },
          {
            pos: `${-width / 2} ${wallHeight / 2} 0`,
            size: `${wallThickness} ${wallHeight} ${length}`,
          },
          {
            pos: `${width / 2} ${wallHeight / 2} 0`,
            size: `${wallThickness} ${wallHeight} ${length}`,
          },
        ];

        walls.forEach((wall, i) => {
          const wallEl = document.createElement("a-box");
          wallEl.setAttribute("position", wall.pos);
          const [w, h, d] = wall.size.split(" ");
          wallEl.setAttribute("width", w);
          wallEl.setAttribute("height", h);
          wallEl.setAttribute("depth", d);
          wallEl.setAttribute("color", "#f8f8f8");
          wallEl.setAttribute("material", "roughness: 0.7; metalness: 0.1");
          wallEl.setAttribute("shadow", "cast: true; receive: true");
          wallsContainer.appendChild(wallEl);
        });

        // Add a grid helper for better spatial awareness
        createGridHelper(width, length);
      }

      function togglePanel() {
        panelOpen = !panelOpen;
        const panel = document.getElementById("side-panel");
        const toggle = document.getElementById("panel-toggle");
        const backButton = document.getElementById("back-button");

        if (panelOpen) {
          panel.classList.add("open");
          toggle.innerHTML = "‚úï";
          toggle.style.left = "310px";
          // Move back button to the right when panel is open
          if (backButton) {
            backButton.style.left = "310px";
          }
        } else {
          panel.classList.remove("open");
          toggle.innerHTML = "üì¶";
          toggle.style.left = "20px";
          // Move back button back to original position when panel is closed
          if (backButton) {
            backButton.style.left = "20px";
          }
        }
      }

      function goBack() {
        window.location.href = "index.html";
      }

      function toggleInstructions() {
        const instructions = document.getElementById("instructions");
        const toggle = document.getElementById("instructions-toggle");

        instructions.classList.toggle("collapsed");

        if (instructions.classList.contains("collapsed")) {
          toggle.textContent = "?";
        } else {
          toggle.textContent = "‚àí";
        }
      }

      function initializeDragAndDrop() {
        // Only enable drag for enabled items (table)
        const enabledItems = document.querySelectorAll(".model-item.enabled");
        const scene = document.getElementById("scene");
        const dropIndicator = document.getElementById("drop-indicator");

        enabledItems.forEach((item) => {
          item.addEventListener("dragstart", handleDragStart);
        });

        // Scene drop events
        scene.addEventListener("dragover", handleDragOver);
        scene.addEventListener("drop", handleDrop);
        scene.addEventListener("dragenter", handleDragEnter);
        scene.addEventListener("dragleave", handleDragLeave);
      }

      function handleDragStart(e) {
        draggedItem = {
          model: e.target.dataset.model,
          scale: e.target.dataset.scale,
          name: e.target.querySelector(".model-name").textContent,
        };
        e.target.classList.add("dragging");

        // Hide the drop indicator when dragging starts
        const dropIndicator = document.getElementById("drop-indicator");
        dropIndicator.classList.remove("show");
      }

      function handleDragOver(e) {
        e.preventDefault();
      }

      function handleDragEnter(e) {
        e.preventDefault();
        document.getElementById("drop-indicator").classList.add("show");
      }

      function handleDragLeave(e) {
        if (
          !e.relatedTarget ||
          !document.getElementById("scene").contains(e.relatedTarget)
        ) {
          document.getElementById("drop-indicator").classList.remove("show");
        }
      }

      function handleDrop(e) {
        e.preventDefault();
        document.getElementById("drop-indicator").classList.remove("show");

        if (!draggedItem) return;

        // Calculate drop position (center of room with slight randomization)
        const dropX = (Math.random() - 0.5) * 2;
        const dropZ = (Math.random() - 0.5) * 2;

        // Get room dimensions for smart placement
        const roomWidth = parseFloat(localStorage.getItem("roomWidth")); // Already in meters
        const roomLength = parseFloat(localStorage.getItem("roomLength"));

        // Create furniture entity
        const furnitureEl = document.createElement("a-entity");
        furnitureEl.id = `furniture-${furnitureCounter++}`;
        furnitureEl.setAttribute("position", `${dropX} 0 ${dropZ}`);
        furnitureEl.setAttribute(
          "obj-model",
          `obj: url(models/${draggedItem.model}.obj)`
        );
        furnitureEl.setAttribute("scale", draggedItem.scale);
        furnitureEl.setAttribute(
          "draggable-furniture",
          `roomWidth: ${roomWidth}; roomLength: ${roomLength}; objectWidth: 1.5; objectLength: 1.5; wallThickness: 0.1`
        );
        furnitureEl.setAttribute("clickable-furniture", "");
        furnitureEl.setAttribute("material", "color: #8B4513"); // Brown color for table

        // Add to scene
        document.getElementById("furniture-container").appendChild(furnitureEl);

        // Update cost estimator
        addItemToCost(draggedItem.model, draggedItem.name);

        // Clean up
        document.querySelectorAll(".model-item.dragging").forEach((item) => {
          item.classList.remove("dragging");
        });

        // Remove the drop indicator permanently after first furniture placement
        const dropIndicator = document.getElementById("drop-indicator");
        if (dropIndicator) {
          dropIndicator.style.display = "none";
        }

        console.log(
          `Added ${draggedItem.name} to room at position ${dropX}, ${dropZ}`
        );
        draggedItem = null;
      }

      function addItemToCost(modelKey, displayName) {
        const price = PRICE_LIST[modelKey] || 0;
        if (!costState.items[modelKey]) {
          costState.items[modelKey] = {
            name: displayName,
            price: price,
            qty: 0,
          };
        }
        costState.items[modelKey].qty += 1;
        renderCost();
      }

      function peso(n) {
        return `‚Ç±${Number(n).toLocaleString("en-PH", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        })}`;
      }

      // Some MSDF fonts in a-text may not include the peso glyph.
      // Use a 3D-safe fallback for in-scene text.
      function peso3D(n) {
        return `PHP ${Number(n).toLocaleString("en-PH", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        })}`;
      }

      function renderCost() {
        // Update HTML panel if present
        const itemsContainer = document.getElementById("cost-items");
        if (itemsContainer) {
          itemsContainer.innerHTML = "";
        }
        let total = 0;
        // Update 3D board lines
        const linesRoot = document.getElementById("cost-lines");
        if (linesRoot) {
          while (linesRoot.firstChild)
            linesRoot.removeChild(linesRoot.firstChild);
        }
        let y = 0; // start at 0, step down per line
        Object.keys(costState.items).forEach((key) => {
          const item = costState.items[key];
          const lineTotal = item.price * item.qty;
          total += lineTotal;
          // HTML list (if exists)
          if (itemsContainer) {
            const row = document.createElement("div");
            row.className = "cost-item";
            row.innerHTML = `
              <div>
                <div class="cost-item-name">${item.name}</div>
                <div class="cost-item-meta">${item.qty} √ó ${peso(
              item.price
            )}</div>
              </div>
              <div>${peso(lineTotal)}</div>
            `;
            itemsContainer.appendChild(row);
          }
          // 3D board line
          if (linesRoot) {
            const line = document.createElement("a-text");
            line.setAttribute(
              "value",
              `${item.name} x ${item.qty} = ${peso3D(lineTotal)}`
            );
            line.setAttribute("color", "#333");
            line.setAttribute("position", `0 ${y.toFixed(2)} 0`);
            line.setAttribute("width", "2.6");
            linesRoot.appendChild(line);
            y -= 0.18; // line spacing
          }
        });
        costState.total = total;
        const totalEl = document.getElementById("cost-total");
        if (totalEl) totalEl.textContent = peso(total);
        const total3D = document.getElementById("cost-total-text");
        if (total3D) total3D.setAttribute("value", `Total: ${peso3D(total)}`);
      }

      // Create a subtle grid helper for better spatial awareness
      function createGridHelper(roomWidth, roomLength) {
        const gridContainer = document.getElementById("grid-helper");
        gridContainer.innerHTML = "";

        const gridSize = 0.5; // 50cm grid squares
        const gridColor = "#e0e0e0";
        const gridOpacity = 0.3;

        // Create grid lines along width
        for (let x = -roomWidth / 2; x <= roomWidth / 2; x += gridSize) {
          const line = document.createElement("a-box");
          line.setAttribute("position", `${x} 0.001 0`);
          line.setAttribute("width", "0.02");
          line.setAttribute("height", "0.001");
          line.setAttribute("depth", roomLength);
          line.setAttribute("color", gridColor);
          line.setAttribute("opacity", gridOpacity);
          gridContainer.appendChild(line);
        }

        // Create grid lines along length
        for (let z = -roomLength / 2; z <= roomLength / 2; z += gridSize) {
          const line = document.createElement("a-box");
          line.setAttribute("position", `0 0.001 ${z}`);
          line.setAttribute("width", roomWidth);
          line.setAttribute("height", "0.001");
          line.setAttribute("depth", "0.02");
          line.setAttribute("color", gridColor);
          line.setAttribute("opacity", gridOpacity);
          gridContainer.appendChild(line);
        }
      }

      // Keyboard shortcuts
      document.addEventListener("keydown", function (e) {
        if (e.key === "Tab") {
          e.preventDefault();
          togglePanel();
        }
        if (e.key === "Escape") {
          goBack();
        }
        if (e.key === "g" || e.key === "G") {
          // Toggle grid visibility
          const grid = document.getElementById("grid-helper");
          const isVisible = grid.getAttribute("visible") !== "false";
          grid.setAttribute("visible", !isVisible);
          console.log("Grid", isVisible ? "hidden" : "shown");
        }
        if (e.key === "h" || e.key === "H") {
          // Toggle instructions
          e.preventDefault();
          toggleInstructions();
        }
      });

      // Sub-category functions
      function showWardrobeSubcategory() {
        const subcategory = document.getElementById("wardrobe-subcategory");
        if (subcategory.style.display === "none") {
          subcategory.style.display = "block";
          // Re-initialize drag and drop for new items
          initializeDragAndDrop();
        } else {
          subcategory.style.display = "none";
        }
      }

      // Control panel functions
      function showControlPanel(furnitureId) {
        selectedFurniture = furnitureId;
        const panel = document.getElementById("furniture-control-panel");
        const title = document.getElementById("control-panel-title");
        title.textContent = `Controls for ${furnitureId}`;
        panel.style.display = "block";
      }

      function closeControlPanel() {
        const panel = document.getElementById("furniture-control-panel");
        panel.style.display = "none";
        selectedFurniture = null;
      }

      function rotateFurnitureLeft() {
        if (selectedFurniture) {
          const furniture = document.getElementById(selectedFurniture);
          if (furniture) {
            const currentRotation = furniture.getAttribute("rotation");
            const newRotation = (parseFloat(currentRotation.y) - 90) % 360;
            furniture.setAttribute(
              "rotation",
              `${currentRotation.x} ${newRotation} ${currentRotation.z}`
            );
            console.log(
              `Rotated ${selectedFurniture} left to ${newRotation} degrees`
            );
          }
        }
      }

      function rotateFurnitureRight() {
        if (selectedFurniture) {
          const furniture = document.getElementById(selectedFurniture);
          if (furniture) {
            const currentRotation = furniture.getAttribute("rotation");
            const newRotation = (parseFloat(currentRotation.y) + 90) % 360;
            furniture.setAttribute(
              "rotation",
              `${currentRotation.x} ${newRotation} ${currentRotation.z}`
            );
            console.log(
              `Rotated ${selectedFurniture} right to ${newRotation} degrees`
            );
          }
        }
      }

      function deleteFurniture() {
        if (selectedFurniture) {
          const furniture = document.getElementById(selectedFurniture);
          if (furniture) {
            // Remove from cost estimator
            const modelKey = furniture
              .getAttribute("obj-model")
              .match(/models\/(\w+)\.obj/)[1];
            if (costState.items[modelKey]) {
              costState.items[modelKey].qty -= 1;
              if (costState.items[modelKey].qty <= 0) {
                delete costState.items[modelKey];
              }
              renderCost();
            }

            // Remove from scene
            furniture.remove();
            console.log(`Deleted ${selectedFurniture}`);
            closeControlPanel();
          }
        }
      }

      // Initialize room when page loads
      window.addEventListener("load", function () {
        // Make sure A-Frame scene is ready
        const scene = document.querySelector("a-scene");
        if (scene.hasLoaded) {
          initializeRoom();
        } else {
          scene.addEventListener("loaded", function () {
            console.log("A-Frame scene loaded, initializing room...");
            initializeRoom();
          });
        }
      });
    </script>
  </body>
</html>
